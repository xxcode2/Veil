<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veil - Private Voting Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; }
    .screen { display: none; }
    .screen.active { display: flex; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spin { animation: spin 1s linear infinite; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">

<!-- ========================= SCREEN: HOME ========================= -->
<div id="screen-home" class="screen active flex-col items-center justify-center min-h-screen p-6">
  <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
    <div class="text-center mb-8">
      <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-xl flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
        </svg>
      </div>
      <h1 class="text-3xl font-bold text-gray-900">Veil</h1>
      <p class="text-gray-600 mt-2">Private voting game powered by Arcium</p>
    </div>

    <div class="space-y-4">
      <button onclick="createRoom()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-xl transition">
        Create New Room
      </button>
      
      <div class="relative">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-300"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-white text-gray-500">or</span>
        </div>
      </div>

      <div class="space-y-3">
        <input 
          type="text" 
          id="join-room-input"
          placeholder="Enter room code (e.g., VEIL-ABC123)"
          class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none uppercase"
          maxlength="11"
        />
        <button onclick="joinRoom()" class="w-full bg-white hover:bg-gray-50 text-blue-600 font-semibold py-3 px-6 rounded-xl border-2 border-blue-600 transition">
          Join Room
        </button>
      </div>
    </div>

    <div class="mt-6 p-4 bg-blue-50 rounded-xl">
      <p class="text-sm text-gray-700">
        <strong>No wallet needed!</strong> Players use anonymous IDs only.
      </p>
    </div>
  </div>
</div>

<!-- ========================= SCREEN: LOBBY ========================= -->
<div id="screen-lobby" class="screen flex-col min-h-screen p-6">
  <div class="max-w-2xl w-full mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-gray-900">Room Lobby</h2>
        <button onclick="leaveRoom()" class="text-red-600 hover:text-red-700 font-medium">Leave</button>
      </div>
      
      <div class="flex items-center gap-4 mb-4">
        <div class="flex-1 bg-gray-100 rounded-lg p-3 text-center">
          <div class="text-2xl font-bold text-gray-900" id="lobby-room-code">VEIL-XXXX</div>
          <div class="text-sm text-gray-600">Room Code</div>
        </div>
        <button onclick="copyRoomCode()" class="p-3 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
          </svg>
        </button>
      </div>

      <div class="text-sm text-gray-600">
        <span id="lobby-player-count">0</span> / 8 players
      </div>
    </div>

    <!-- Players List -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Players</h3>
      <div id="lobby-players-list" class="space-y-2">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Start Button (Host only) -->
    <div id="lobby-host-controls" class="hidden">
      <button onclick="startVoting()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-4 px-6 rounded-xl transition">
        Start Voting (Host Only)
      </button>
    </div>

    <div id="lobby-waiting" class="text-center text-gray-600">
      Waiting for host to start...
    </div>
  </div>
</div>

<!-- ========================= SCREEN: VOTING ========================= -->
<div id="screen-voting" class="screen flex-col items-center justify-center min-h-screen p-6">
  <div class="max-w-md w-full">
    <div class="bg-white rounded-2xl shadow-xl p-8">
      <h2 class="text-2xl font-bold text-gray-900 text-center mb-6">Cast Your Vote</h2>
      
      <div class="mb-6">
        <p class="text-gray-700 text-center mb-4">Should we go with option A or B?</p>
        <div class="flex items-center justify-center gap-2 text-sm text-gray-500">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
          </svg>
          <span>Your vote is encrypted</span>
        </div>
      </div>

      <div class="space-y-3 mb-6">
        <button onclick="castVote('SAFE')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-xl transition">
          Vote SAFE
        </button>
        <button onclick="castVote('UNSAFE')" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-4 px-6 rounded-xl transition">
          Vote UNSAFE
        </button>
      </div>

      <div id="vote-status" class="text-center text-sm text-gray-600">
        <!-- Status updates -->
      </div>
    </div>
  </div>
</div>

<!-- ========================= SCREEN: PROCESSING ========================= -->
<div id="screen-processing" class="screen flex-col items-center justify-center min-h-screen p-6">
  <div class="text-center">
    <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4 spin"></div>
    <h2 class="text-2xl font-bold text-gray-900 mb-2">Processing Votes</h2>
    <p class="text-gray-600">Arcium MPC is computing the result...</p>
    <div id="processing-status" class="mt-4 text-sm text-gray-500">
      <!-- Vote count -->
    </div>
  </div>
</div>

<!-- ========================= SCREEN: RESULT ========================= -->
<div id="screen-result" class="screen flex-col items-center justify-center min-h-screen p-6">
  <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
    <h2 class="text-2xl font-bold text-gray-900 text-center mb-6">Results</h2>
    
    <div class="space-y-4 mb-6">
      <div class="p-4 bg-blue-50 rounded-xl">
        <div class="text-sm text-gray-600 mb-1">Community Vote</div>
        <div id="result-majority" class="text-2xl font-bold text-gray-900">SAFE</div>
      </div>

      <div class="p-4 bg-purple-50 rounded-xl">
        <div class="text-sm text-gray-600 mb-1">Saboteur Voted</div>
        <div id="result-saboteur-vote" class="text-xl font-bold text-gray-900">UNSAFE</div>
      </div>

      <div id="result-your-status" class="p-4 bg-green-50 rounded-xl">
        <div class="text-sm text-gray-600 mb-1">Your Status</div>
        <div class="font-semibold text-gray-900">You voted correctly!</div>
      </div>
    </div>

    <button onclick="playAgain()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition">
      Play Again
    </button>
  </div>
</div>

<!-- ========================= JAVASCRIPT ========================= -->
<script type="module">
// ================= STATE =================
let ws = null;
let currentPlayerId = null;
let currentRoomId = null;
let currentRoom = null;
let isHost = false;
let mxePublicKey = null;
let clientKeyPair = null;

// Auto-detect environment and configure URLs
const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';

const HTTP_API = isProduction 
  ? (window.VEIL_BACKEND_URL || 'https://your-backend.up.railway.app')
  : 'http://localhost:3000';

const WS_URL = isProduction
  ? (window.VEIL_WS_URL || 'wss://your-backend.up.railway.app')
  : 'ws://localhost:3001';

// Log configuration
console.log('üîß Veil Config:', { HTTP_API, WS_URL, isProduction });

// ================= UTILITY =================
function goToScreen(screenName) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(`screen-${screenName}`).classList.add('active');
}

function showError(message) {
  alert('Error: ' + message);
}

// ================= PLAYER IDENTITY =================
function getOrCreatePlayerId() {
  let id = localStorage.getItem('veil_player_id');
  if (!id) {
    id = `player_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem('veil_player_id', id);
  }
  return id;
}

// ================= ROOM MANAGEMENT =================
window.createRoom = async function() {
  try {
    const response = await fetch(`${HTTP_API}/room/create`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await response.json();
    
    if (data.success) {
      currentRoomId = data.roomId;
      currentPlayerId = data.playerId;
      currentRoom = data.room;
      isHost = true;
      
      // Store in localStorage
      localStorage.setItem('veil_player_id', currentPlayerId);
      localStorage.setItem('veil_room_id', currentRoomId);
      
      await connectWebSocket();
      updateLobbyUI();
      goToScreen('lobby');
    } else {
      showError('Failed to create room');
    }
  } catch (err) {
    console.error('Create room error:', err);
    showError('Connection error');
  }
};

window.joinRoom = async function() {
  const roomCode = document.getElementById('join-room-input').value.trim().toUpperCase();
  
  if (!roomCode) {
    showError('Please enter a room code');
    return;
  }

  try {
    const response = await fetch(`${HTTP_API}/room/join`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ roomId: roomCode })
    });
    
    const data = await response.json();
    
    if (data.success) {
      currentRoomId = data.room.roomId;
      currentPlayerId = data.playerId;
      currentRoom = data.room;
      isHost = false;
      
      localStorage.setItem('veil_player_id', currentPlayerId);
      localStorage.setItem('veil_room_id', currentRoomId);
      
      await connectWebSocket();
      updateLobbyUI();
      goToScreen('lobby');
    } else {
      showError(data.error || 'Failed to join room');
    }
  } catch (err) {
    console.error('Join room error:', err);
    showError('Connection error');
  }
};

window.leaveRoom = function() {
  if (ws) ws.close();
  localStorage.removeItem('veil_room_id');
  currentRoomId = null;
  currentRoom = null;
  goToScreen('home');
};

window.copyRoomCode = function() {
  if (currentRoomId) {
    navigator.clipboard.writeText(currentRoomId);
    alert(`Room code copied: ${currentRoomId}`);
  }
};

// ================= WEBSOCKET =================
async function connectWebSocket() {
  return new Promise((resolve, reject) => {
    ws = new WebSocket(WS_URL);
    
    ws.onopen = () => {
      console.log('‚úÖ WebSocket connected');
      resolve();
    };

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      handleWebSocketMessage(msg);
    };

    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
      reject(error);
    };

    ws.onclose = () => {
      console.log('WebSocket closed');
    };
  });
}

function handleWebSocketMessage(msg) {
  console.log('üì® Received:', msg.type);

  if (msg.type === 'MXE_KEY') {
    mxePublicKey = msg.mxePublicKey;
    console.log('üîë MXE public key received');
    
    // Authenticate
    ws.send(JSON.stringify({
      type: 'AUTH',
      playerId: currentPlayerId,
      roomId: currentRoomId
    }));
  }

  else if (msg.type === 'ROOM_STATE') {
    currentRoom = msg.room;
    updateLobbyUI();
    
    // If status changed to voting, go to voting screen
    if (msg.room.status === 'voting') {
      goToScreen('voting');
    } else if (msg.room.status === 'processing') {
      goToScreen('processing');
    } else if (msg.room.status === 'result') {
      goToScreen('result');
    }
  }

  else if (msg.type === 'VOTE_COUNT') {
    document.getElementById('vote-status').textContent = 
      `Votes: ${msg.votesReceived}/${msg.totalPlayers}`;
    document.getElementById('processing-status').textContent = 
      `${msg.votesReceived} of ${msg.totalPlayers} votes received`;
  }

  else if (msg.type === 'RESULT') {
    displayResult(msg);
  }

  else if (msg.type === 'ERROR') {
    showError(msg.message);
  }
}

// ================= LOBBY UI =================
function updateLobbyUI() {
  if (!currentRoom) return;

  document.getElementById('lobby-room-code').textContent = currentRoom.roomId;
  document.getElementById('lobby-player-count').textContent = currentRoom.playerCount;

  // Update players list
  const playersList = document.getElementById('lobby-players-list');
  playersList.innerHTML = '';
  
  currentRoom.players.forEach(player => {
    const div = document.createElement('div');
    div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
    
    const isCurrentPlayer = player.playerId === currentPlayerId;
    const hostBadge = player.isHost ? '<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded ml-2">HOST</span>' : '';
    const youBadge = isCurrentPlayer ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded ml-2">YOU</span>' : '';
    
    div.innerHTML = `
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-purple-400"></div>
        <span class="font-medium text-gray-900">Player ${player.playerId.substr(-6)}</span>
        ${hostBadge}
        ${youBadge}
      </div>
      <div class="text-xs ${player.connected ? 'text-green-600' : 'text-gray-400'}">
        ${player.connected ? '‚óè  Online' : '‚óã Offline'}
      </div>
    `;
    
    playersList.appendChild(div);
  });

  // Show/hide host controls
  if (isHost) {
    document.getElementById('lobby-host-controls').classList.remove('hidden');
    document.getElementById('lobby-waiting').classList.add('hidden');
  } else {
    document.getElementById('lobby-host-controls').classList.add('hidden');
    document.getElementById('lobby-waiting').classList.remove('hidden');
  }
}

// ================= VOTING =================
window.startVoting = function() {
  if (!isHost) return;
  
  ws.send(JSON.stringify({
    type: 'START_VOTE'
  }));
};

window.castVote = async function(voteChoice) {
  try {
    // Generate client keypair for ECDH
    const clientPrivateKey = crypto.getRandomValues(new Uint8Array(32));
    const clientPublicKey = await generatePublicKey(clientPrivateKey);
    
    // Prepare vote data
    const voteData = { vote: voteChoice, timestamp: Date.now() };
    const voteBytes = new TextEncoder().encode(JSON.stringify(voteData));
    
    // Generate nonce
    const nonce = crypto.getRandomValues(new Uint8Array(12));
    
    // Simple XOR encryption (for demo - in production use proper Rescue cipher)
    const encryptedVote = new Uint8Array(voteBytes.length);
    const seed = await crypto.subtle.digest('SHA-256', clientPublicKey);
    const keyBytes = new Uint8Array(seed);
    
    for (let i = 0; i < voteBytes.length; i++) {
      encryptedVote[i] = voteBytes[i] ^ keyBytes[i % keyBytes.length];
    }
    
    // Send encrypted vote
    ws.send(JSON.stringify({
      type: 'VOTE',
      encryptedVote: arrayBufferToBase64(encryptedVote),
      clientPublicKey: arrayBufferToBase64(clientPublicKey),
      nonce: arrayBufferToBase64(nonce)
    }));
    
    console.log('‚úÖ Encrypted vote sent:', voteChoice);
    document.getElementById('vote-status').textContent = 'Vote submitted! Waiting for others...';
    
  } catch (err) {
    console.error('Vote error:', err);
    showError('Failed to cast vote');
  }
};

// ================= RESULTS =================
function displayResult(result) {
  document.getElementById('result-majority').textContent = result.majorityVote;
  document.getElementById('result-saboteur-vote').textContent = result.saboteurVote;
  
  const statusEl = document.getElementById('result-your-status');
  if (result.isSaboteur) {
    statusEl.className = 'p-4 bg-purple-50 rounded-xl';
    statusEl.innerHTML = `
      <div class="text-sm text-gray-600 mb-1">Your Status</div>
      <div class="font-semibold text-purple-900">You were the Saboteur!</div>
    `;
  } else if (result.yourVoteCorrect) {
    statusEl.className = 'p-4 bg-green-50 rounded-xl';
    statusEl.innerHTML = `
      <div class="text-sm text-gray-600 mb-1">Your Status</div>
      <div class="font-semibold text-green-900">You voted correctly! ‚úì</div>
    `;
  } else {
    statusEl.className = 'p-4 bg-red-50 rounded-xl';
    statusEl.innerHTML = `
      <div class="text-sm text-gray-600 mb-1">Your Status</div>
      <div class="font-semibold text-red-900">Your vote was incorrect</div>
    `;
  }
  
  goToScreen('result');
}

window.playAgain = function() {
  if (!isHost) {
    goToScreen('lobby');
    return;
  }
  
  ws.send(JSON.stringify({
    type: 'RESET'
  }));
  
  goToScreen('lobby');
};

// ================= CRYPTO HELPERS =================
async function generatePublicKey(privateKey) {
  // Simplified public key generation for demo
  return await crypto.subtle.digest('SHA-256', privateKey);
}

function arrayBufferToBase64(buffer) {
  const bytes = new Uint8Array(buffer);
  let binary = '';
  for (let i = 0; i < bytes.length; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}

// ================= AUTO-RECONNECT =================
window.addEventListener('load', async () => {
  const savedRoomId = localStorage.getItem('veil_room_id');
  const savedPlayerId = localStorage.getItem('veil_player_id');
  
  if (savedRoomId && savedPlayerId) {
    try {
      const response = await fetch(`${HTTP_API}/room/${savedRoomId}`);
      const data = await response.json();
      
      if (data.success) {
        currentRoomId = savedRoomId;
        currentPlayerId = savedPlayerId;
        currentRoom = data.room;
        
        const player = data.room.players.find(p => p.playerId === savedPlayerId);
        if (player) {
          isHost = player.isHost;
          await connectWebSocket();
          updateLobbyUI();
          goToScreen('lobby');
        }
      }
    } catch (err) {
      console.log('Could not reconnect to room');
      localStorage.removeItem('veil_room_id');
    }
  }
});
</script>

</body>
</html>
